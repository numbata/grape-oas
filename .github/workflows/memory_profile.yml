name: Memory Profile

on:
  pull_request:
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Number of iterations'
        required: false
        default: '5'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  memory-profile:
    name: Memory Profiling (Ruby ${{ matrix.ruby-version }})
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ruby-version: ['3.4', '4.0']

    steps:
      - uses: actions/checkout@v6

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}
          bundler-cache: true

      - name: Run memory benchmark
        id: benchmark
        env:
          ITERATIONS: ${{ github.event.inputs.iterations || '5' }}
        run: |
          echo "Starting benchmark for Ruby ${{ matrix.ruby-version }}..."
          START_TIME=$(date +%s)
          
          REPORT=$(bundle exec ruby benchmark/memory_profile.rb --markdown)
          
          END_TIME=$(date +%s)
          ELAPSED_TIME=$((END_TIME - START_TIME))
          
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "elapsed_time=$ELAPSED_TIME" >> $GITHUB_OUTPUT
          echo "ruby_version=${{ matrix.ruby-version }}" >> $GITHUB_OUTPUT

      - name: Upload benchmark results
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-results-ruby-${{ matrix.ruby-version }}
          path: |
            benchmark/memory_report.md
          retention-days: 5
          if-no-files-found: ignore

      - name: Save benchmark data
        run: |
          mkdir -p /tmp/benchmark-data
          cat > /tmp/benchmark-data/ruby-${{ matrix.ruby-version }}.json << 'EOF'
          {
            "ruby_version": "${{ matrix.ruby-version }}",
            "elapsed_time": ${{ steps.benchmark.outputs.elapsed_time }},
            "report": ${{ toJSON(steps.benchmark.outputs.report) }}
          }
          EOF

      - name: Upload benchmark data artifact
        uses: actions/upload-artifact@v6
        with:
          name: benchmark-data-ruby-${{ matrix.ruby-version }}
          path: /tmp/benchmark-data/ruby-${{ matrix.ruby-version }}.json
          retention-days: 1

      - name: Check for memory leaks
        run: |
          bundle exec ruby -e "
            require 'json'
            require_relative 'benchmark/memory_profile'

            benchmark = MemoryBenchmark.new(format: :json)
            benchmark.run
            result = JSON.parse(benchmark.report)

            if result['summary']['potential_leak']
              puts '::warning::Potential memory leak detected in Ruby ${{ matrix.ruby-version }}!'
              exit 1
            else
              puts 'No memory leak detected in Ruby ${{ matrix.ruby-version }}.'
            end
          "

  compare-results:
    name: Compare Ruby Versions
    needs: memory-profile
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6

      - name: Download Ruby 3.4 results
        uses: actions/download-artifact@v6
        with:
          name: benchmark-data-ruby-3.4
          path: /tmp/results-3.4

      - name: Download Ruby 4.0 results
        uses: actions/download-artifact@v6
        with:
          name: benchmark-data-ruby-4.0
          path: /tmp/results-4.0

      - name: Generate comparison report
        id: comparison
        run: |
          cat > /tmp/compare.rb << 'RUBY_SCRIPT'
          require 'json'
          
          ruby34_data = JSON.parse(File.read('/tmp/results-3.4/ruby-3.4.json'))
          ruby40_data = JSON.parse(File.read('/tmp/results-4.0/ruby-4.0.json'))
          
          # Extract metrics from the reports
          def extract_metrics(report)
            lines = report.split("\n")
            metrics = {}
            
            lines.each do |line|
              if line.include?('Avg Allocated')
                metrics[:avg_allocated] = line.split('|')[2].strip
              elsif line.include?('Avg Retained')
                metrics[:avg_retained] = line.split('|')[2].strip
              elsif line.include?('Retained Trend')
                metrics[:retained_trend] = line.split('|')[2].strip
              end
            end
            
            metrics
          end
          
          def parse_bytes(str)
            return 0.0 if str.nil? || str.empty?
            value, unit = str.split(' ')
            value = value.to_f
            case unit
            when 'KB' then value * 1024
            when 'MB' then value * 1024 * 1024
            when 'GB' then value * 1024 * 1024 * 1024
            else value
            end
          end
          
          def format_bytes(bytes)
            return "0 B" if bytes.zero?
            units = %w[B KB MB GB]
            exp = (Math.log(bytes.abs) / Math.log(1024)).to_i
            exp = [exp, units.size - 1].min
            format("%.2f %s", bytes.to_f / (1024**exp), units[exp])
          end
          
          def calculate_percentage_diff(old_val, new_val)
            return 0.0 if old_val.zero?
            ((new_val - old_val) / old_val * 100.0).round(2)
          end
          
          metrics_34 = extract_metrics(ruby34_data['report'])
          metrics_40 = extract_metrics(ruby40_data['report'])
          
          allocated_34 = parse_bytes(metrics_34[:avg_allocated])
          allocated_40 = parse_bytes(metrics_40[:avg_allocated])
          retained_34 = parse_bytes(metrics_34[:avg_retained])
          retained_40 = parse_bytes(metrics_40[:avg_retained])
          
          allocated_diff = allocated_40 - allocated_34
          retained_diff = retained_40 - retained_34
          allocated_pct = calculate_percentage_diff(allocated_34, allocated_40)
          retained_pct = calculate_percentage_diff(retained_34, retained_40)
          
          time_diff = ruby40_data['elapsed_time'] - ruby34_data['elapsed_time']
          time_pct = calculate_percentage_diff(ruby34_data['elapsed_time'].to_f, ruby40_data['elapsed_time'].to_f)
          
          allocated_indicator = allocated_pct > 0 ? "üìà" : (allocated_pct < 0 ? "üìâ" : "‚û°Ô∏è")
          retained_indicator = retained_pct > 0 ? "üìà" : (retained_pct < 0 ? "üìâ" : "‚û°Ô∏è")
          time_indicator = time_pct > 0 ? "üêå" : (time_pct < 0 ? "‚ö°" : "‚û°Ô∏è")
          
          comparison_report = <<~REPORT
          ## Memory Profile Comparison: Ruby 3.4 vs Ruby 4.0
          
          ### Benchmark Execution Time
          | Ruby Version | Time (seconds) | Difference |
          |--------------|----------------|------------|
          | Ruby 3.4 | #{ruby34_data['elapsed_time']}s | baseline |
          | Ruby 4.0 | #{ruby40_data['elapsed_time']}s | #{time_indicator} #{time_diff > 0 ? '+' : ''}#{time_diff}s (#{time_pct > 0 ? '+' : ''}#{time_pct}%) |
          
          ### Memory Usage Comparison
          | Metric | Ruby 3.4 | Ruby 4.0 | Difference | % Change |
          |--------|----------|----------|------------|----------|
          | **Avg Allocated** | #{metrics_34[:avg_allocated]} | #{metrics_40[:avg_allocated]} | #{allocated_indicator} #{allocated_diff > 0 ? '+' : ''}#{format_bytes(allocated_diff)} | #{allocated_pct > 0 ? '+' : ''}#{allocated_pct}% |
          | **Avg Retained** | #{metrics_34[:avg_retained]} | #{metrics_40[:avg_retained]} | #{retained_indicator} #{retained_diff > 0 ? '+' : ''}#{format_bytes(retained_diff)} | #{retained_pct > 0 ? '+' : ''}#{retained_pct}% |
          | **Retained Trend** | #{metrics_34[:retained_trend]} | #{metrics_40[:retained_trend]} | - | - |
          
          ### Summary
          #{
            if allocated_pct < -5 || retained_pct < -5
              "‚úÖ **Ruby 4.0 shows improved memory efficiency** compared to Ruby 3.4"
            elsif allocated_pct > 5 || retained_pct > 5
              "‚ö†Ô∏è **Ruby 4.0 uses more memory** compared to Ruby 3.4"
            else
              "‚ÑπÔ∏è **Similar memory usage** between Ruby 3.4 and Ruby 4.0"
            end
          }
          
          #{
            if time_pct < -5
              "‚úÖ **Ruby 4.0 is faster** than Ruby 3.4"
            elsif time_pct > 5
              "‚ö†Ô∏è **Ruby 4.0 is slower** than Ruby 3.4"
            else
              "‚ÑπÔ∏è **Similar performance** between Ruby 3.4 and Ruby 4.0"
            end
          }
          
          ---
          
          <details>
          <summary>üìä Ruby 3.4 Detailed Report</summary>
          
          #{ruby34_data['report']}
          
          </details>
          
          <details>
          <summary>üìä Ruby 4.0 Detailed Report</summary>
          
          #{ruby40_data['report']}
          
          </details>
          
          ---
          <sub>Generated by Memory Profile workflow ‚Ä¢ Commit: ${{ github.sha }}</sub>
          REPORT
          
          puts comparison_report
          RUBY_SCRIPT
          
          echo "report<<EOF" >> $GITHUB_OUTPUT
          ruby /tmp/compare.rb >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find existing comment
        uses: peter-evans/find-comment@v4
        id: find-comment
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '## Memory Profile Comparison'

      - name: Post or update PR comment
        uses: peter-evans/create-or-update-comment@v5
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: ${{ steps.comparison.outputs.report }}
          edit-mode: replace

      - name: Upload comparison report
        uses: actions/upload-artifact@v6
        with:
          name: memory-comparison-report
          path: /tmp/comparison.md
          if-no-files-found: ignore
          retention-days: 30
